name: Integration
on:
  push:
    paths-ignore:
    - .frontmatter/*
    - .github/*
    - .vscode/*
  pull_request:
    types:
    - synchronize
    - reopened
    - opened
    paths:
    - .frontmatter/*
    - .github/*
    - .vscode/*
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
    - name: checkout
      uses: actions/checkout@v4
    - name: direnv nix
      uses: JRMurr/direnv-nix-action@v4.1.0
      with:
        install-nix: true
        cache-store: true
    - name: configure repository
      run: task configure
    - name: pre-commit checks
      run: lefthook run pre-commit --all-files --no-tty
      env:
        REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: pre-push checks
      run: lefthook run pre-push --all-files --no-tty
    - name: assert clean repository
      run: test -z "$(git diff --shortstat | head -c1)"
    - name: upload golangci-lint SARIF
      uses: github/codeql-action/upload-sarif@v2
      if: ${{ hashFiles('golangci-lint.sarif') != '' }}
      with:
        sarif_file: golangci-lint.sarif
        category: golangci-lint
        token: ${{ secrets.GITHUB_TOKEN }}

name: Update

on:
  push:
    paths:
    - .github/workflows/update.yml
  schedule:
    - cron: "0 8 */1 * *"
  workflow_dispatch:
  workflow_run:
    workflows: [Build]
    branches: [master]
    types: [completed]

env:
  GOLANG_VERSION: 1.21

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    name: Update
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/master' }}
    steps:

      - name: checkout
        uses: actions/checkout@v4

      - name: download artifact
        id: download-artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: build.yaml
          workflow_conclusion: success
          branch: master
          name: site-binary
          path: /usr/local/bin
          allow_forks: false

      - name: chmod
        run: chmod +x /usr/local/bin/site

      - name: update data
        run: site data update
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}

      - name: commit changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: |-
            chore: updated site data

            Signed-off-by: Github Actions <actions@github.com>
          commit_user_name: Github Actions
          commit_user_email: actions@github.com
          commit_author: Github Actions <actions@github.com>
          branch: chore/data-update/${{ github.run_id }}-${{ github.run_attempt }}

      - name: create pull request
        run: |-
          pr() { gh pr create $* || gh pr edit $* }
          pr --title "chore: updated site data" --label automerge
